<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GödleHex</title>
  <style>
    /* ===== Base layout & theme ===== */
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #121212; 
      color: #eee; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      padding: 2rem;
      margin: 0;
      min-height: 100vh;
    }
    h1 { 
      font-size: 2.8rem; 
      margin-bottom: 1rem; 
      color: #ff3b3b; /* red accent */
      text-shadow: 0 0 10px rgba(255, 59, 59, 0.5);
    }
    .game-area { 
      display: flex; 
      align-items: flex-start; 
      gap: 2rem; 
      flex-wrap: wrap; 
      justify-content: center; 
      margin: 1rem 0;
    }
    .questions { 
      font-size: 1.2rem; 
      min-width: 280px; 
      display: flex; 
      flex-direction: column; 
      gap: 1rem; 
      min-height: 60px;
    }
    .question-container { display: flex; align-items: center; gap: 0.5rem; }
    .question-text { 
      background-color: #333; 
      border-left: 4px solid #ff3b3b; 
      padding: 0.8rem; 
      font-weight: bold; 
      border-radius: 4px; 
      flex-grow: 1;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      color: #eee;
    }
    .question-result { 
      font-size: 1.8rem; 
      min-width: 40px;
      text-align: center;
      color: #ff3b3b;
    }

    /* ===== Upward pyramid ===== */
    .guesses {
      display: flex;
      flex-direction: column-reverse; /* stack upward */
      align-items: flex-start;        /* keep left aligned */
      width: 100%;
      max-width: 20rem;
    }
    .row { 
      display: flex; 
      justify-content: center; /* centered rows for pyramid look */
      margin: 0.5rem 0; 
      align-items: center; 
    }
    .row.final-row { justify-content: flex-start; } /* final code row left-aligned */

    .cell { 
      width: 3rem; 
      height: 3rem; 
      font-size: 1.5rem; 
      margin: 0.2rem; 
      text-align: center; 
      border: 2px solid #444; 
      border-radius: 8px; 
      background: #222; 
      color: #fff;
      font-weight: bold;
      transition: all 0.25s ease;
    }
    .cell:focus {
      outline: none;
      border-color: #ff3b3b;
      box-shadow: 0 0 10px rgba(255, 59, 59, 0.5);
    }
    .cell.green { 
      background: #2eff6a; /* brighter green */
      border-color: #18b84a;
      color: #071208;
      transform: scale(1.05);
    }
    .cell.yellow { 
      background: #ffe34d; /* brighter yellow */
      border-color: #d1a200;
      color: #241c00;
      transform: scale(1.05);
    }
    .cell.gray { 
      background: #7f8c8d; 
      border-color: #636e72;
      color: #111;
    }

    #submit { 
      margin-top: 1.5rem; 
      padding: 0.8rem 1.5rem; 
      font-size: 1.1rem; 
      width: 100%; 
      max-width: 300px; 
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      background: #ff3b3b; /* red primary button */
      color: white;
    }
    #submit:hover {
      background: #e02d2d; /* darker red */
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    #game-over { 
      margin-top: 1.5rem; 
      font-size: 1.5rem; 
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.06);
      animation: fadeIn 0.5s ease-in;
      display: block; /* filled at end */
      color: #eee;
    }

    #start-screen { 
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0; 
      background: #121212; 
      color: #eee; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      text-align: center; 
      padding: 2rem; 
      z-index: 999;
      animation: fadeIn 0.5s ease-in;
    }
    #start-button { 
      margin-top: 2rem; 
      padding: 1rem 2rem; 
      font-size: 1.3rem; 
      cursor: pointer; 
      background: #ff3b3b; /* red start button */
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    #start-button:hover {
      background: #e02d2d;
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }

    #timer { 
      margin-top: 1rem; 
      font-size: 1.3rem; 
      color: #ff3b3b; /* red accent */
      font-weight: bold;
    }

    #tracker { 
      margin-top: 2rem; 
      font-size: 1.2rem; 
      max-width: 360px; 
      text-align: center; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
      justify-content: center; 
    }
    .tracker-char { 
      padding: 0.3rem 0.6rem; 
      border: 1px solid #888; 
      border-radius: 5px; 
      background: #1e1e1e; 
      color: #ff3b3b; 
      transition: transform 0.2s ease;
    }
    .tracker-char.used { text-decoration: line-through; color: #555; transform: scale(0.95); }
 .share-buttons { 
      display: flex; 
      gap: 1rem; 
      margin-top: 1.5rem; 
      justify-content: center; 
      flex-wrap: wrap; 
    }
    .share-button { 
      padding: 0.8rem 1.5rem; 
      border-radius: 8px; 
      border: none; 
      cursor: pointer; 
      font-size: 1rem; 
      display: flex; 
      align-items: center; 
      gap: 0.5rem; 
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .share-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    .share-button.twitter { background: #1DA1F2; color: white; }
    .share-button.facebook { background: #4267B2; color: white; }
    .share-button.copy { background: #333; color: white; }
    #copy-message { 
      margin-top: 1rem; 
      color: #00bcd4; 
      display: none;
      animation: fadeIn 0.5s ease-in;
    }
    #share-results { 
      margin-top: 2rem; 
      display: none; 
      text-align: center;
      animation: fadeIn 0.5s ease-in;
    }
    footer { 
      margin-top: 3rem; 
      font-size: 0.9rem; 
      color: #777; 
      text-align: center; 
      padding: 1.5rem;
      border-top: 1px solid #333;
      width: 100%;
      max-width: 600px;
    }

    @media (max-width: 600px) {
      body { padding: 1rem; }
      .cell { width: 2.8rem; height: 2.8rem; font-size: 1.3rem; }
      .game-area { flex-direction: column; align-items: center; }
      .questions { min-width: 100%; }
      h1 { font-size: 2.2rem; }
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ===== Slide Menu (off-canvas) ===== */
    #menu-toggle {
      position: fixed;
      top: 14px;
      left: 14px;
      z-index: 1100;
      background: #ff3b3b;
      color: #fff;
      border: none;
      padding: 0.55rem 0.9rem;
      border-radius: 10px;
      font-weight: 700;
      letter-spacing: .2px;
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
      cursor: pointer;
      transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
    }
    #menu-toggle:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,.45); background:#e02d2d; }
    #menu-toggle:active { transform: translateY(0); }

    #menu-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(2px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s ease;
      z-index: 1000;
    }

    #side-menu {
      position: fixed;
      top: 0; left: 0;
      height: 100vh;
      width: 320px;
      max-width: 86vw;
      background: #1b1b1b;
      color: #eee;
      border-right: 1px solid #2a2a2a;
      box-shadow: 8px 0 24px rgba(0,0,0,.45);
      transform: translateX(-100%);
      transition: transform .28s ease;
      z-index: 1050;
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      outline: none;
    }
    #side-menu h2 { margin: 0 0 6px; color: #ff6666; font-size: 1.3rem; }
    #side-menu p { margin: 0 0 10px; color: #ccc; line-height: 1.35; }
    #side-menu .login-row { display:flex; gap:8px; }
    #side-menu input[type="text"] {
      flex: 1;
      padding: .55rem .7rem;
      border-radius: 8px;
      border: 1px solid #3a3a3a;
      background:#222; color:#eee;
    }
    #side-menu button[type="submit"], #logout-button {
      background:#ff3b3b; color:#fff; border:none; border-radius:8px; padding:.55rem .8rem; font-weight:700; cursor:pointer;
    }
    #side-menu a.external-link { color:#ff8a80; text-decoration:none; }
    #side-menu a.external-link:hover { text-decoration:underline; }

    /* Streak styles */
    .streak-panel { 
      margin-top: 6px; padding: 10px 12px; border-radius: 10px; background:#1f1f1f; border:1px solid #2a2a2a; 
      box-shadow: inset 0 0 0 1px rgba(255,59,59,0.06);
    }
    .streak-panel h3 { margin: 0 0 8px; font-size: 1.05rem; color:#ff7a7a; }
    .streak-row { display:flex; align-items: baseline; gap:8px; font-weight:700; }
    #streak-count { font-size: 1.6rem; color:#ffd1d1; }
    .streak-note { display:block; margin-top:6px; color:#9d9d9d; font-size: .85rem; }
    .auth-status { color:#ddd; font-size:.95rem; }

    /* Open state */
    .menu-open #menu-backdrop { opacity: 1; pointer-events: auto; }
    .menu-open #side-menu { transform: translateX(0); }
    .menu-open #menu-toggle { background:#2b2b2b; color:#ffb3b3; }

    /* Motion safety */
    @media (prefers-reduced-motion: reduce) { #menu-backdrop, #side-menu, #menu-toggle { transition: none !important; } }
  </style>
</head>
<body>
  <div id="start-screen">
    <h1>Welcome to Gödle Hex</h1>
    <p>A puzzle that uses logic and math with the same rules as Gödle</p>
    <ul style="text-align: left; max-width: 400px;">
      <li>Start at the <strong>bottom</strong> row and work your way up.</li>
      <li>Answer 5 questions using hexadecimal digits (0–9, A–F).</li>
      <li>Green = correct digit & position; Yellow = correct digit, wrong position.</li>
      <li>One digit won’t be used and is placed at the end of the final 7-character row.</li>
      <li>Good luck!</li>
    </ul>
    <button id="start-button">Start Game</button>
  </div>

  <!-- Pull out menu modal -->
  <button id="menu-toggle" type="button" aria-expanded="true" aria-controls="side-menu" aria-label="Toggle game menu">✕ Close</button>
  <div id="menu-backdrop" role="presentation"></div>
  <aside id="side-menu" aria-hidden="false" tabindex="-1">
    <h2>Game Menu</h2>
    <p>Sign in to track your streak, then use the Start Game button below the board whenever you're ready to play.</p>
    <div class="login-panel" aria-live="polite">
      <form id="login-form">
        <label for="username-input">Player username</label>
        <div class="login-row">
          <input id="username-input" name="username" type="text" placeholder="Enter username" autocomplete="nickname" required />
          <button type="submit" id="login-button">Log In</button>
        </div>
      </form>
      <button id="logout-button" type="button" style="display: none;">Log Out</button>
      <p class="login-hint">Your daily streak is saved per username on this device.</p>
      <a class="external-link" href="https://cordell33.github.io/GodlePuzzle/" target="_blank" rel="noopener noreferrer">Godle (daily)</a>
    </div>
    <div id="auth-status" class="auth-status" style="display:none;">Logged in as <strong id="current-username"></strong></div>
    <div class="streak-panel" id="streak-panel" hidden>
      <h3>🔥 Weekly Streak</h3>
      <div class="streak-row">
        <span id="streak-count">0</span> weeks
      </div>
      <small class="streak-note">Increments when you log in during a new week (Sun–Sat, your local time).</small>
    </div>
  </aside>

  <h1>Gödle Hex</h1>
  <div class="game-area">
    <div class="questions" id="questions"></div>
    <div class="guesses" id="guess-container"></div>
  </div>
  <button id="submit">Submit Guess</button>
  <div id="timer">⏱ 00:00</div>
  <div id="game-over"></div>
  <!-- Share results UI (appears after game over) -->
  <div id="share-results" class="share-buttons" style="display:none;">
    <button id="share-twitter" class="share-button twitter" type="button" aria-label="Share on X (Twitter)">Share on X</button>
    <button id="share-facebook" class="share-button facebook" type="button" aria-label="Share on Facebook">Share on Facebook</button>
    <button id="share-copy" class="share-button copy" type="button" aria-label="Copy results">Copy</button>
  </div>
  <div id="copy-message" style="display:none; text-align:center; margin-top:.5rem;">Copied to clipboard ✅</div>
  <div id="tracker"></div>
  <footer>created by Cordell Booth</footer>

  <script>
    // ===== Slide Menu Controller =====
    (function(){
      // Ensure external links work inside menu
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.external-link').forEach(link => {
          link.addEventListener('click', (e) => {
            e.stopPropagation(); // prevents the menu toggle from interfering
          });
        });
      });
      const btn = document.getElementById('menu-toggle');
      const aside = document.getElementById('side-menu');
      const backdrop = document.getElementById('menu-backdrop');
      let lastFocus = null;

      const focusableSel = 'a[href], button:not([disabled]), input, textarea, select, [tabindex]:not([tabindex="-1"])';

      function isOpen(){ return document.body.classList.contains('menu-open'); }
      function open(){
        if (isOpen()) return;
        lastFocus = document.activeElement;
        document.body.classList.add('menu-open');
        btn.setAttribute('aria-expanded','true');
        aside.setAttribute('aria-hidden','false');
        btn.textContent = '✕ Close';
        setTimeout(()=>{
          const first = aside.querySelector(focusableSel) || aside;
          first.focus();
        }, 0);
      }
      function close(){
        if (!isOpen()) return;
        document.body.classList.remove('menu-open');
        btn.setAttribute('aria-expanded','false');
        aside.setAttribute('aria-hidden','true');
        btn.textContent = '☰ Menu';
        if (lastFocus && typeof lastFocus.focus === 'function') lastFocus.focus();
      }
      function toggle(){ isOpen() ? close() : open(); }

      (btn.getAttribute('aria-expanded') === 'true') ? open() : close();
      btn.addEventListener('click', toggle);
      backdrop.addEventListener('click', close);
      window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') close(); });

      aside.addEventListener('keydown', (e)=>{
        if (!isOpen() || e.key !== 'Tab') return;
        const items = Array.from(aside.querySelectorAll(focusableSel)).filter(el => el.offsetParent !== null);
        if (!items.length) return;
        const first = items[0];
        const last = items[items.length - 1];
        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
        else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
      });
    })();
  </script>

  <script>
    // ===== Auth + Weekly Streak (Sun–Sat, no reset) =====
    (function(){
      const loginForm = document.getElementById('login-form');
      const usernameInput = document.getElementById('username-input');
      const loginBtn = document.getElementById('login-button');
      const logoutBtn = document.getElementById('logout-button');
      const authStatus = document.getElementById('auth-status');
      const currentUserEl = document.getElementById('current-username');
      const streakPanel = document.getElementById('streak-panel');
      const streakCountEl = document.getElementById('streak-count');

      let loggedInUser = null;

      function storageKey(user){ return `ghx_user_${user}`; }

      function getWeekKey(date = new Date()){
        // Sunday-based weeks (local time): key is Sunday-of-week anchored week number
        const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const day = d.getDay(); // 0=Sun..6=Sat
        const sunday = new Date(d);
        sunday.setDate(d.getDate() - day); // back to Sunday
        const year = sunday.getFullYear();
        const firstJan = new Date(year, 0, 1);
        const firstJanDow = firstJan.getDay();
        const firstSunday = new Date(firstJan);
        firstSunday.setDate(firstJan.getDate() - firstJanDow); // Sunday on/before Jan 1
        const diffDays = Math.floor((sunday - firstSunday) / 86400000);
        const week = Math.floor(diffDays / 7) + 1;
        return `${year}-W${String(week).padStart(2,'0')}`;
      }

      // expose helpers for testing
      window.__ghx_getWeekKey = getWeekKey;

      function loadUser(user){
        try { return JSON.parse(localStorage.getItem(storageKey(user))) || null; }
        catch { return null; }
      }
      function saveUser(user, data){ localStorage.setItem(storageKey(user), JSON.stringify(data)); }

      function updateStreakOnLogin(user){
        const nowKey = getWeekKey();
        let data = loadUser(user) || { streak: 0, lastWeek: null };
        if (data.lastWeek !== nowKey) {
          // new week detected → increment once, never reset for gaps
          data.streak = (data.streak || 0) + 1;
          data.lastWeek = nowKey;
        }
        saveUser(user, data);
        streakCountEl.textContent = String(data.streak || 0);
      }
      window.__ghx_updateStreakOnLogin = updateStreakOnLogin; // test hook

      function setLoggedInUI(user){
        loggedInUser = user;
        authStatus.style.display = 'block';
        currentUserEl.textContent = user;
        streakPanel.hidden = false;
        loginForm.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        const data = loadUser(user) || { streak: 0 };
        streakCountEl.textContent = String(data.streak || 0);
      }
      function setLoggedOutUI(){
        loggedInUser = null;
        authStatus.style.display = 'none';
        streakPanel.hidden = true;
        loginForm.style.display = 'block';
        logoutBtn.style.display = 'none';
        currentUserEl.textContent = '';
      }

      loginForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        const user = (usernameInput.value || '').trim();
        if (!user) return;
        updateStreakOnLogin(user);
        setLoggedInUI(user);
        localStorage.setItem('ghx_last_user', user);
      });
      logoutBtn.addEventListener('click', ()=>{ setLoggedOutUI(); });

      // Prefill last username (no auto-increment)
      const lastUser = localStorage.getItem('ghx_last_user');
      if (lastUser) { usernameInput.value = lastUser; }
    })();

    // ===== Game Logic =====
    const pyramid = [1, 2, 3, 4, 5, 7];
    const code = [3, "E", 7, 0, 9, 8, "A"];

    const questions = [
      "Carbon symbol",
      "Volume dimensions",
      "2nd month (abbr.)",
      "83 × 25",
      "15000 - 311",
      "Enter the 6-digit code, then the unused digit"
    ];

    const correctAnswers = [
      ["C"],
      [3, "D"],
      ["F", "E", "B"],
      [2, 0, 7, 5],
      [1, 4, 6, 8, 9],
      [3, "E", 7, 0, 9, 8, "A"]
    ];

    let currentStep = 0;

    const questionsDiv = document.getElementById("questions");
    const guessContainer = document.getElementById("guess-container");
    const submitBtn = document.getElementById("submit");
    const gameOverDiv = document.getElementById("game-over");
    const startScreen = document.getElementById("start-screen");
    const startButton = document.getElementById("start-button");
    const trackerDiv = document.getElementById("tracker");
    const timerDiv = document.getElementById("timer");

    let usedCharacters = new Set();
    let questionElements = [];

    const hexChars = [...Array(10).keys()].map(String).concat(["A","B","C","D","E","F"]);
    function updateTracker() {
      trackerDiv.innerHTML = "";
      hexChars.forEach(char => {
        const span = document.createElement("span");
        span.className = "tracker-char" + (usedCharacters.has(char) ? " used" : "");
        span.textContent = char;
        trackerDiv.appendChild(span);
      });
    }

    // ⏱ Timer helpers
    let startTime = null;
    let timerInterval = null;

    function formatSeconds(total) {
      const m = String(Math.floor(total / 60)).padStart(2, '0');
      const s = String(total % 60).padStart(2, '0');
      return `${m}:${s}`;
    }

    function startTimer() {
      startTime = Date.now();
      timerDiv.textContent = '⏱ 00:00';
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        timerDiv.textContent = `⏱ ${formatSeconds(elapsed)}`;
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      return formatSeconds(elapsed);
    }

    function renderQuestion() {
      // Clear previous questions and only show current one
      questionsDiv.innerHTML = '';
      
      const qWrap = document.createElement("div");
      qWrap.className = "question-container";
      qWrap.id = `question-${currentStep}`;

      const qText = document.createElement("div");
      qText.className = "question-text";
      qText.textContent = questions[currentStep];
      qWrap.appendChild(qText);

      const resultSpan = document.createElement("div");
      resultSpan.className = "question-result";
      resultSpan.id = `result-${currentStep}`;
      qWrap.appendChild(resultSpan);

      questionsDiv.appendChild(qWrap);
      questionElements.push(qWrap);

      const rowDiv = document.createElement("div");
      rowDiv.className = (currentStep === pyramid.length - 1) ? "row final-row" : "row";
      rowDiv.id = `row-${currentStep}`;
      for (let i = 0; i < pyramid[currentStep]; i++) {
        const input = document.createElement("input");
        input.className = "cell active";
        input.maxLength = 1;
        input.type = "text";
        input.autocapitalize = "characters";
        input.addEventListener("input", (e) => {
          input.value = input.value.toUpperCase().replace(/[^0-9A-F]/g, "");
          if (e.target.value.length === 1 && i < pyramid[currentStep] - 1) {
            rowDiv.children[i + 1].focus();
          }
        });
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") submitBtn.click();
          if ((e.key === "Backspace" || e.key === "Delete") && e.target.value === "" && i > 0) {
            rowDiv.children[i - 1].focus();
          }
        });
        rowDiv.appendChild(input);
      }

      guessContainer.appendChild(rowDiv);
      rowDiv.children[0].focus();
    }

    function getActiveInputs() { return Array.from(document.querySelectorAll(".cell.active")); }
    function getInputValues()  { return getActiveInputs().map(input => input.value.trim()); }

    function shakeRow(rowDiv) {
      rowDiv.classList.add("shake");
      setTimeout(() => rowDiv.classList.remove("shake"), 300);
    }

    function evaluateRow(values, rowDiv) {
      const inputDigits = values.map(v => (isNaN(v) ? v.toUpperCase() : Number(v)));
      const expected = correctAnswers[currentStep];

      const isCorrect = inputDigits.length === expected.length && inputDigits.every((val, i) => {
        const exp = expected[i];
        return (typeof exp === "string") ? String(val).toUpperCase() === exp.toUpperCase() : val === exp;
      });

      if (!isCorrect) {
        shakeRow(rowDiv);
        return false;
      }

      document.getElementById(`result-${currentStep}`).textContent = "✅";

      const feedback = inputDigits.map((digit, i) => {
        const d = String(digit).toUpperCase();
        if (String(code[i]).toUpperCase() === d) return "green";
        if (code.map(x => String(x).toUpperCase()).includes(d)) return "yellow";
        return "gray";
      });

      getActiveInputs().forEach((input, i) => {
        input.classList.remove("active");
        input.classList.add(feedback[i]);
        input.disabled = true;
      });

      inputDigits.forEach(d => usedCharacters.add(String(d).toUpperCase()));
      updateTracker();
      return true;
    }

    function hideAnsweredQuestions() {
      // Hide all questions except the current one (defensive if multiple were present)
      questionElements.forEach((element, index) => {
        if (index !== currentStep) {
          element.classList.add('hidden');
        }
      });
    }

    // ===== Sharing helpers =====
   function buildShareText() {
  // Collect all rows, then drop the final 7-cell row
  const rows = Array.from(document.querySelectorAll('.guesses .row'));
  const playableRows = rows.slice(0, -1);

  // Map to 🟩 🟨 ⬛ only
  const mapColor = (el) =>
    el.classList.contains('green') ? '🟩' :
    el.classList.contains('yellow') ? '🟨' : '⬛';

  // Reverse so the grid reads top→bottom visually
  const grid = playableRows
    .map(r => Array.from(r.querySelectorAll('.cell')).map(mapColor).join(''))
    .reverse()
    .join('\n');

  const time = (timerDiv ? timerDiv.textContent.replace('⏱','').trim() : '').trim();
  return `${time}\n${grid}`.trim();  // time + boxes only

    }

    async function copyResults() {
      const text = buildShareText();
      try { await navigator.clipboard.writeText(text); } catch {}
      const copyMsg = document.getElementById('copy-message');
      if (copyMsg) { copyMsg.style.display = 'block'; setTimeout(()=>copyMsg.style.display='none', 2000); }
    }

    function shareOnTwitter(){
      const text = buildShareText();
      window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank', 'noopener');
    }

    function shareOnFacebook(){
      const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(buildShareText())}`;
      const win = window.open(shareUrl, 'fb-share-dialog', 'width=626,height=436');
      if (!win) { copyResults(); alert('Facebook share popup was blocked. Your results were copied—paste into Facebook manually.'); }
    }

    // Hook up buttons (if they exist)
    (function(){
      const sr = document.getElementById('share-results');
      const tw = document.getElementById('share-twitter');
      const fb = document.getElementById('share-facebook');
      const cp = document.getElementById('share-copy');
      if (tw) tw.addEventListener('click', shareOnTwitter);
      if (fb) fb.addEventListener('click', shareOnFacebook);
      if (cp) cp.addEventListener('click', copyResults);
      // show when game-over text appears
      const go = document.getElementById('game-over');
      if (go && sr) {
        const mo = new MutationObserver(()=>{ if (go.textContent.trim().length) sr.style.display = 'flex'; });
        mo.observe(go, { childList:true, subtree:true });
      }
    })();

    submitBtn.addEventListener("click", () => {
      const rowDiv = guessContainer.lastElementChild;
      const values = getInputValues();
      if (values.length < pyramid[currentStep] || values.some(v => v === "")) return;

      const correct = evaluateRow(values, rowDiv);
      if (!correct) return;

      hideAnsweredQuestions();
      
      currentStep++;
      if (currentStep < pyramid.length) {
        renderQuestion();
      } else {
        const guess = values.map(v => (isNaN(v) ? v.toUpperCase() : Number(v)));
        const solved = guess.every((d, i) => d === code[i]);
        const finalTime = stopTimer();
        gameOverDiv.innerHTML = solved ? `🎉 You cracked the code in ${finalTime}!` : `❌ Incorrect. The code was ${code.join("")}. Time: ${finalTime}`;
        submitBtn.disabled = true;
      }
    });

    startButton.addEventListener("click", () => {
      startScreen.style.display = "none";
      updateTracker();
      startTimer();
      renderQuestion();
    });

    /* ==================
       Dev Self-Tests
       Run in console: runTests()
       ================== */
    function runTests() {
      console.log("Running Gödle Hex tests...");
      console.assert(document.getElementById('timer'), 'Timer element should exist');
      console.assert(typeof startTimer === 'function', 'startTimer should be defined');
      console.assert(typeof stopTimer === 'function', 'stopTimer should be defined');
      console.assert(typeof formatSeconds === 'function', 'formatSeconds should be defined');
      console.assert(formatSeconds(0) === '00:00', 'formatSeconds(0)');
      console.assert(formatSeconds(5) === '00:05', 'formatSeconds(5)');
      console.assert(formatSeconds(65) === '01:05', 'formatSeconds(65)');

      // New tests: final row alignment
      const prevStep = currentStep;
      currentStep = pyramid.length - 1;
      renderQuestion();
      const lastRow = document.getElementById(`row-${currentStep}`);
      console.assert(lastRow && lastRow.classList.contains('final-row'), 'Final row should have class final-row');
      // cleanup
      currentStep = prevStep; 
      
      // New tests: Sunday-based week key should change across Sat->Sun
      const wkSat = window.__ghx_getWeekKey(new Date('2025-09-27')); // Saturday
      const wkSun = window.__ghx_getWeekKey(new Date('2025-09-28')); // Sunday next week
      console.assert(wkSat !== wkSun, 'Week key should change from Saturday to next Sunday');
      const wkSun2 = window.__ghx_getWeekKey(new Date('2025-09-28'));
      const wkFri = window.__ghx_getWeekKey(new Date('2025-10-03')); // same Sun-Sat week
      console.assert(wkSun2 === wkFri, 'Sunday and following Friday should share the same week key');

      console.log("All tests passed ✅");
    }
    window.runTests = runTests;
  </script>
</body>
</html>
