<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>G√∂dleHex</title>
  <style>
    /* ===== Base layout & theme ===== */
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #121212; 
      color: #eee; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      padding: 2rem;
      margin: 0;
      min-height: 100vh;
    }
    h1 { 
      font-size: 2.8rem; 
      margin-bottom: 1rem; 
      color: #ff3b3b; /* red accent */
      text-shadow: 0 0 10px rgba(255, 59, 59, 0.5);
    }
    .game-area { 
      display: flex; 
      align-items: flex-start; 
      gap: 2rem; 
      flex-wrap: wrap; 
      justify-content: center; 
      margin: 1rem 0;
    }
    .questions { 
      font-size: 1.2rem; 
      min-width: 280px; 
      display: flex; 
      flex-direction: column; 
      gap: 1rem; 
      min-height: 60px;
    }
    .question-container { display: flex; align-items: center; gap: 0.5rem; }
    .question-text { 
      background-color: #333; 
      border-left: 4px solid #ff3b3b; 
      padding: 0.8rem; 
      font-weight: bold; 
      border-radius: 4px; 
      flex-grow: 1;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      color: #eee;
    }
    .question-result { 
      font-size: 1.8rem; 
      min-width: 40px;
      text-align: center;
      color: #ff3b3b;
    }

    /* ===== Upward pyramid (right-aligned) ===== */
    .guesses {
      display: flex;
      flex-direction: column-reverse; /* stack upward */
      align-items: flex-end;          /* anchor to the right */
      width: 100%;
      max-width: 28rem;
    }
    .row { 
      display: flex; 
      justify-content: center;        /* centered contents for pyramid look */
      margin: 0.5rem 0; 
      align-items: center; 
    }
    .row.final-row { justify-content: flex-start; } /* final code row left-aligned */

    .cell { 
      width: 3rem; 
      height: 3rem; 
      font-size: 1.5rem; 
      margin: 0.2rem; 
      text-align: center; 
      border: 2px solid #444; 
      border-radius: 8px; 
      background: #222; 
      color: #fff;
      font-weight: bold;
      transition: all 0.25s ease;
    }
    .cell:focus {
      outline: none;
      border-color: #ff3b3b;
      box-shadow: 0 0 10px rgba(255, 59, 59, 0.5);
    }
    .cell.green { 
      background: #2eff6a; /* brighter green */
      border-color: #18b84a;
      color: #071208;
      transform: scale(1.05);
    }
    .cell.yellow { 
      background: #ffe34d; /* brighter yellow */
      border-color: #d1a200;
      color: #241c00;
      transform: scale(1.05);
    }
    .cell.gray { 
      background: #7f8c8d; 
      border-color: #636e72;
      color: #111;
    }

    /* Shake animation */
    @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-6px)} 50%{transform:translateX(6px)} 75%{transform:translateX(-6px)} 100%{transform:translateX(0)} }
    .shake { animation: shake .26s; }

    #submit { 
      margin-top: 1.5rem; 
      padding: 0.8rem 1.5rem; 
      font-size: 1.1rem; 
      width: 100%; 
      max-width: 300px; 
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      background: #ff3b3b; /* red primary button */
      color: white;
    }
    #submit:hover { background: #e02d2d; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }

    #game-over {
      margin-top: 1.5rem;
      font-size: 1.5rem;
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.06);
      animation: fadeIn 0.5s ease-in;
      display: block; /* filled at end */
      color: #eee;
    }
    #game-over.win { color: #9effa8; }
    #game-over.loss { color: #ff9ea0; }
    body.light-mode #game-over {
      background: rgba(0, 0, 0, 0.05);
      color: #111;
    }
    body.light-mode #game-over.win { color: #000; }
    body.light-mode #game-over.loss { color: #c62828; }

    #start-screen { 
      position: fixed; inset: 0; 
      background: #121212; 
      color: #eee; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      text-align: center; 
      padding: 2rem; 
      z-index: 999;
      animation: fadeIn 0.5s ease-in;
    }
    #start-button { 
      margin-top: 2rem; 
      padding: 1rem 2rem; 
      font-size: 1.3rem; 
      cursor: pointer; 
      background: #ff3b3b; /* red start button */
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    #start-button:hover { background: #e02d2d; transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); }

    #timer { margin-top: 1rem; font-size: 1.3rem; color: #ff3b3b; font-weight: bold; }

    #tracker {
      margin: 2rem auto 0;
      max-width: 360px;
      display: grid;
      grid-template-columns: repeat(8, minmax(0, 1fr));
      gap: 0.35rem;
      justify-items: center;
    }
    .tracker-char {
      padding: 0.2rem 0.4rem;
      border: 1px solid #888;
      border-radius: 5px;
      background: #1e1e1e;
      color: #ff3b3b;
      font-size: 1rem;
      transition: transform 0.2s ease;
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 1.6rem;
    }
    .tracker-char:focus { outline: 2px solid #ff3b3b; outline-offset: 2px; }
    .tracker-char.used { text-decoration: line-through; color: #555; transform: scale(0.95); }

    .share-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center; flex-wrap: wrap; }
    .share-button { padding: 0.8rem 1.5rem; border-radius: 8px; border: none; cursor: pointer; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; font-weight: bold; transition: all 0.3s ease; }
    .share-button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
    .share-button.twitter { background: #1DA1F2; color: white; }
    .share-button.facebook { background: #4267B2; color: white; }
    .share-button.copy { background: #333; color: white; }
    #copy-message { margin-top: 1rem; color: #00bcd4; display: none; animation: fadeIn 0.5s ease-in; }
    #share-results { margin-top: 2rem; display: none; text-align: center; animation: fadeIn 0.5s ease-in; }

    footer { margin-top: 3rem; font-size: 0.9rem; color: #777; text-align: center; padding: 1.5rem; border-top: 1px solid #333; width: 100%; max-width: 600px; }

    @media (max-width: 600px) {
      body { padding: 1rem; }
      .cell { width: 2.8rem; height: 2.8rem; font-size: 1.3rem; }
      .game-area { flex-direction: column; align-items: center; }
      .questions { min-width: 100%; }
      h1 { font-size: 2.2rem; }
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ===== Slide Menu (off-canvas) ===== */
    #menu-toggle {
      position: fixed; top: 1rem; left: 1rem; z-index: 1100;
      background: #00bcd4; color: #121212; border: none; border-radius: 999px;
      padding: 0.55rem 1.1rem; font-size: 1.1rem; font-weight: 700; cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); transition: background 0.2s ease, transform 0.2s ease;
    }
    #menu-toggle:hover { background: #00a0b7; transform: translateY(-1px); }
    body.menu-open #menu-toggle { background: #0097a7; color: #fff; }
    #menu-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 1000; }
    body.menu-open #menu-backdrop { opacity: 1; pointer-events: auto; }
    #side-menu {
      position: fixed; top: 0; left: 0; height: 100vh; width: min(320px, 85vw);
      background: #1b1b1b; box-shadow: 8px 0 24px rgba(0, 0, 0, 0.45);
      transform: translateX(-100%); transition: transform 0.3s ease; z-index: 1050;
      padding: 1.5rem 1.75rem 2rem; display: flex; flex-direction: column; gap: 1.5rem; overflow-y: auto;
    }
    body.menu-open #side-menu { transform: translateX(0); }
    #side-menu h2 { margin: 0; color: #00bcd4; font-size: 1.5rem; text-shadow: 0 0 8px rgba(0, 188, 212, 0.4); }
    #side-menu p { margin: 0; color: #ddd; line-height: 1.4; }
    .login-panel { margin-top: 1.5rem; background: rgba(255, 255, 255, 0.05); padding: 1rem 1.5rem; border-radius: 12px; max-width: 420px; width: 100%; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25); }
    .login-panel label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
    .login-row { display: flex; gap: 0.5rem; }
    .login-panel input[type="text"] { flex: 1; padding: 0.6rem 0.8rem; border-radius: 8px; border: 1px solid #444; background: #1e1e1e; color: #fff; font-size: 1rem; }
    .login-panel input[type="text"]:focus { outline: none; border-color: #00bcd4; box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.2); }
    .login-panel button { padding: 0.6rem 1.2rem; border-radius: 8px; border: none; background: #00bcd4; color: #fff; font-weight: 600; cursor: pointer; transition: background 0.2s ease; }
    .login-panel button:hover { background: #0097a7; }
    .login-panel .external-links { list-style: none; margin: 0.75rem 0 0; padding: 0; display: flex; flex-direction: column; gap: 0.5rem; }
    .login-panel .external-link { display: inline-flex; color: #00bcd4; font-weight: 600; text-decoration: none; transition: color 0.2s ease; }
    .login-panel .external-link:hover { color: #ff9800; text-decoration: underline; }
    .theme-toggle { display: flex; align-items: center; gap: 0.75rem; margin-top: auto; width: 100%; }
    .theme-toggle-input { position: absolute; opacity: 0; width: 0; height: 0; }
    .theme-toggle-label { display: inline-flex; align-items: center; gap: 0.75rem; cursor: pointer; font-weight: 600; color: #f5f5f5; }
    .theme-toggle-track { position: relative; width: 3.2rem; height: 1.6rem; border-radius: 999px; background: #3a3a3a; box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.2); transition: background 0.25s ease; }
    .theme-toggle-thumb { position: absolute; top: 50%; left: 0.25rem; transform: translate(0, -50%); width: 1.1rem; height: 1.1rem; border-radius: 50%; background: #fff; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.35); transition: transform 0.25s ease; }
    .theme-toggle-input:focus-visible + .theme-toggle-label .theme-toggle-track { box-shadow: 0 0 0 3px rgba(255, 59, 59, 0.35); }
    .theme-toggle-input:checked + .theme-toggle-label .theme-toggle-track { background: #ff3b3b; }
    .theme-toggle-input:checked + .theme-toggle-label .theme-toggle-thumb { transform: translate(1.45rem, -50%); }
    .theme-toggle-text { font-size: 1rem; letter-spacing: 0.03em; }
    #logout-button { margin-top: 0.75rem; width: 100%; background: #ef5350; }
    #logout-button:hover { background: #e53935; }
    .login-hint { margin-top: 0.75rem; font-size: 0.9rem; color: #ccc; }

    /* Streak styles */
    .streak-panel { margin-top: 6px; padding: 10px 12px; border-radius: 10px; background:#1f1f1f; border:1px solid #2a2a2a; box-shadow: inset 0 0 0 1px rgba(255,59,59,0.06); }
    .streak-panel h3 { margin: 0 0 8px; font-size: 1.05rem; color:#ff7a7a; }
    .streak-row { display:flex; align-items: baseline; gap:8px; font-weight:700; }
    #streak-count { font-size: 1.6rem; color:#ffd1d1; }
    .streak-note { display:block; margin-top:6px; color:#9d9d9d; font-size: .85rem; }
    .auth-status { color:#ddd; font-size:.95rem; }

    /* Open state */
    .menu-open #menu-backdrop { opacity: 1; pointer-events: auto; }
    .menu-open #side-menu { transform: translateX(0); }
    .menu-open #menu-toggle { background:#2b2b2b; color:#ffb3b3; }

    /* Motion safety */
    @media (prefers-reduced-motion: reduce) { #menu-backdrop, #side-menu, #menu-toggle { transition: none !important; } }

    /* ===== Light mode overrides ===== */
    body.light-mode { background: #f5f6f9; color: #1f1f1f; }
    body.light-mode h1 { color: #c62828; text-shadow: 0 0 10px rgba(198, 40, 40, 0.25); }
    body.light-mode .question-text { background: #ffffff; border-left-color: #c62828; color: #1f1f1f; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
    body.light-mode .question-result { color: #c62828; }
    body.light-mode .cell { background: #ffffff; border-color: #cfd8dc; color: #263238; }
    body.light-mode .cell.green { background: #81c784; border-color: #4caf50; color: #0a2510; }
    body.light-mode .cell.yellow { background: #fff176; border-color: #fdd835; color: #4a3d00; }
    body.light-mode .cell.gray { background: #cfd8dc; border-color: #b0bec5; color: #37474f; }
    body.light-mode #submit { background: #1976d2; color: #fff; }
    body.light-mode #submit:hover { background: #1565c0; box-shadow: 0 4px 10px rgba(21, 101, 192, 0.25); }
    body.light-mode #start-screen { background: rgba(245, 246, 249, 0.97); color: #1f1f1f; }
    body.light-mode #menu-toggle { background: #1976d2; color: #fff; }
    body.light-mode #menu-toggle:hover { background: #1565c0; }
    body.light-mode.menu-open #menu-toggle { background: #115293; color: #e3f2fd; }
    body.light-mode #menu-backdrop { background: rgba(0,0,0,0.35); }
    body.light-mode #side-menu { background: #ffffff; box-shadow: 8px 0 24px rgba(33, 33, 33, 0.18); }
    body.light-mode #side-menu h2 { color: #1976d2; text-shadow: none; }
    body.light-mode #side-menu p { color: #37474f; }
    body.light-mode .login-panel { background: #f1f5f9; border: 1px solid #cfd8dc; box-shadow: 0 6px 14px rgba(33, 33, 33, 0.12); }
    body.light-mode .login-panel input[type="text"] { background: #fff; border-color: #b0bec5; color: #1f1f1f; }
    body.light-mode .login-panel input[type="text"]:focus { border-color: #1976d2; box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.2); }
    body.light-mode .login-panel button { background: #1976d2; }
    body.light-mode .login-panel button:hover { background: #1565c0; }
    body.light-mode .login-panel .external-link { color: #1976d2; }
    body.light-mode .login-panel .external-link:hover { color: #ef6c00; }
    body.light-mode #logout-button { background: #e53935; }
    body.light-mode #logout-button:hover { background: #c62828; }
    body.light-mode .login-hint { color: #607d8b; }
    body.light-mode .streak-panel { background: #ffffff; border-color: #e0e0e0; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    body.light-mode .streak-panel h3 { color: #d84315; }
    body.light-mode #streak-count { color: #c62828; }
    body.light-mode .streak-note { color: #546e7a; }
    body.light-mode .auth-status { color: #37474f; }
    body.light-mode #timer { color: #c62828; }
    body.light-mode footer { color: #607d8b; border-top-color: #cfd8dc; }
    body.light-mode .share-button.copy { background: #eceff1; color: #263238; }
    body.light-mode .tracker-char { background: #eceff1; color: #d84315; border-color: #cfd8dc; }
    body.light-mode .tracker-char.used { color: #90a4ae; }
    body.light-mode .theme-toggle-label { color: #1f1f1f; }
    body.light-mode .theme-toggle-track { background: #b0bec5; box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.05); }
    body.light-mode .theme-toggle-input:checked + .theme-toggle-label .theme-toggle-track { background: #1976d2; }
    body.light-mode .theme-toggle-input:checked + .theme-toggle-label .theme-toggle-thumb { box-shadow: 0 2px 6px rgba(25, 118, 210, 0.35); }
    body.light-mode .theme-toggle-text { color: #1f1f1f; }
  </style>
</head>
<body>
  <div id="start-screen">
    <h1>Welcome to G√∂dle Hex</h1>
    <p>A puzzle that uses logic and math with the same rules as G√∂dle</p>
    <ul style="text-align: left; max-width: 400px;">
      <li>Start at the <strong>bottom</strong> row and work your way up.</li>
      <li>Answer 5 questions using hexadecimal digits (0‚Äì9, A‚ÄìF).</li>
      <li>Green = correct digit & position; Yellow = correct digit, wrong position.</li>
      <li>One digit won‚Äôt be used and is placed at the begining of the final 7-character row.</li>
      <li>Good luck!</li>
    </ul>
    <button id="start-button">Start Game</button>
  </div>

  <!-- Pull out menu modal -->
  <button id="menu-toggle" type="button" aria-expanded="true" aria-controls="side-menu" aria-label="Toggle game menu">‚úï Close</button>
  <div id="menu-backdrop" role="presentation"></div>
  <aside id="side-menu" aria-hidden="false" tabindex="-1">
    <h2>Game Menu</h2>
    <p>Sign in to track your streak, then use the Start Game button below the board whenever you're ready to play.</p>
    <div class="login-panel" aria-live="polite">
      <form id="login-form">
        <label for="username-input">Player username</label>
        <div class="login-row">
          <input id="username-input" name="username" type="text" placeholder="Enter username" autocomplete="nickname" required />
          <button type="submit" id="login-button">Log In</button>
        </div>
      </form>
      <button id="logout-button" type="button" style="display: none;">Log Out</button>
      <p class="login-hint">Your daily streak is saved per username on this device.</p>
      <ul class="external-links">
        <li><a class="external-link" href="https://cordell33.github.io/GodlePuzzle/" target="_blank" rel="noopener noreferrer">Godle (daily)</a></li>
        <li><a class="external-link" href="https://cordell33.github.io/Cordlle/" target="_blank" rel="noopener noreferrer">Cordlle (monthly)</a></li>
      </ul>
    </div>
    <div id="auth-status" class="auth-status" style="display:none;">Logged in as <strong id="current-username"></strong></div>
    <div class="streak-panel" id="streak-panel" hidden>
      <h3>üî• Weekly Streak</h3>
      <div class="streak-row">
        <span id="streak-count">0</span> weeks
      </div>
      <small class="streak-note">Increments when you log in during a new week (Sun‚ÄìSat, your local time).</small>
    </div>
    <div class="theme-toggle">
      <input id="theme-toggle-switch" class="theme-toggle-input" type="checkbox" role="switch" aria-checked="false" aria-labelledby="theme-toggle-text" />
      <label for="theme-toggle-switch" class="theme-toggle-label">
        <span class="theme-toggle-track" aria-hidden="true">
          <span class="theme-toggle-thumb"></span>
        </span>
        <span class="theme-toggle-text" id="theme-toggle-text">Enable light mode</span>
      </label>
    </div>
  </aside>

  <h1>G√∂dle Hex</h1>
  <div class="game-area">
    <div class="questions" id="questions"></div>
    <div class="guesses" id="guess-container"></div>
  </div>
  <button id="submit">Submit Guess</button>
  <div id="timer">‚è± 00:00</div>
  <div id="game-over"></div>
  <!-- Share results UI (appears after game over) -->
  <div id="share-results" class="share-buttons" style="display:none;">
    <button id="share-twitter" class="share-button twitter" type="button" aria-label="Share on X (Twitter)">Share on X</button>
    <button id="share-facebook" class="share-button facebook" type="button" aria-label="Share on Facebook">Share on Facebook</button>
    <button id="share-copy" class="share-button copy" type="button" aria-label="Copy results">Copy</button>
  </div>
  <div id="copy-message" style="display:none; text-align:center; margin-top:.5rem;">Copied to clipboard ‚úÖ</div>
  <div id="tracker"></div>
  <footer>created by Cordell Booth</footer>

  <script>
    // ===== Slide Menu Controller =====
    (function(){
      function wireExternalLinks(){
        document.querySelectorAll('.external-link').forEach(link => {
          link.addEventListener('click', (e) => { e.stopPropagation(); });
        });
      }
      // run now and on DOMContentLoaded (in case this script loads before elements exist)
      wireExternalLinks();
      document.addEventListener('DOMContentLoaded', wireExternalLinks);

      const btn = document.getElementById('menu-toggle');
      const aside = document.getElementById('side-menu');
      const backdrop = document.getElementById('menu-backdrop');
      let lastFocus = null;

      const focusableSel = 'a[href], button:not([disabled]), input, textarea, select, [tabindex]:not([tabindex="-1"])';

      function isOpen(){ return document.body.classList.contains('menu-open'); }
      function open(){
        if (isOpen()) return;
        lastFocus = document.activeElement;
        document.body.classList.add('menu-open');
        btn.setAttribute('aria-expanded','true');
        aside.setAttribute('aria-hidden','false');
        btn.textContent = '‚úï Close';
        setTimeout(()=>{
          const first = aside.querySelector(focusableSel) || aside;
          first.focus();
        }, 0);
      }
      function close(){
        if (!isOpen()) return;
        document.body.classList.remove('menu-open');
        btn.setAttribute('aria-expanded','false');
        aside.setAttribute('aria-hidden','true');
        btn.textContent = '‚ò∞ Menu';
        if (lastFocus && typeof lastFocus.focus === 'function') lastFocus.focus();
      }
      function toggle(){ isOpen() ? close() : open(); }

      (btn.getAttribute('aria-expanded') === 'true') ? open() : close();
      btn.addEventListener('click', toggle);
      backdrop.addEventListener('click', close);
      window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') close(); });

      aside.addEventListener('keydown', (e)=>{
        if (!isOpen() || e.key !== 'Tab') return;
        const items = Array.from(aside.querySelectorAll(focusableSel)).filter(el => el.offsetParent !== null);
        if (!items.length) return;
        const first = items[0];
        const last = items[items.length - 1];
        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
        else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
      });
    })();
  </script>

  <script>
    // ===== Theme Toggle =====
    (function(){
      const toggleInput = document.getElementById('theme-toggle-switch');
      const toggleText = document.getElementById('theme-toggle-text');
      if (!toggleInput || !toggleText) return;

      const LIGHT_CLASS = 'light-mode';
      const STORAGE_KEY = 'ghx_light_mode';

      function applyMode(isLight){
        document.body.classList.toggle(LIGHT_CLASS, isLight);
        toggleInput.checked = isLight;
        toggleInput.setAttribute('aria-checked', String(isLight));
        toggleText.textContent = isLight ? 'Disable light mode' : 'Enable light mode';
      }

      let stored = null;
      try {
        stored = localStorage.getItem(STORAGE_KEY);
      } catch (err) {
        stored = null;
      }
      const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      const initial = stored === null ? prefersLight : stored === 'true';
      applyMode(initial);

      toggleInput.addEventListener('change', () => {
        const isLight = toggleInput.checked;
        applyMode(isLight);
        try { localStorage.setItem(STORAGE_KEY, String(isLight)); } catch (err) { /* ignore storage failures */ }
      });
    })();
  </script>

  <script>
    // ===== Auth + Weekly Streak (Sun‚ÄìSat, no reset) =====
    (function(){
      const loginForm = document.getElementById('login-form');
      const usernameInput = document.getElementById('username-input');
      const loginBtn = document.getElementById('login-button');
      const logoutBtn = document.getElementById('logout-button');
      const authStatus = document.getElementById('auth-status');
      const currentUserEl = document.getElementById('current-username');
      const streakPanel = document.getElementById('streak-panel');
      const streakCountEl = document.getElementById('streak-count');

      let loggedInUser = null;

      function storageKey(user){ return `ghx_user_${user}`; }

      function getWeekKey(date = new Date()){
        // Sunday-based weeks (local time): key is Sunday-of-week anchored week number
        const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const day = d.getDay(); // 0=Sun..6=Sat
        const sunday = new Date(d);
        sunday.setDate(d.getDate() - day); // back to Sunday
        const year = sunday.getFullYear();
        const firstJan = new Date(year, 0, 1);
        const firstJanDow = firstJan.getDay();
        const firstSunday = new Date(firstJan);
        firstSunday.setDate(firstJan.getDate() - firstJanDow); // Sunday on/before Jan 1
        const diffDays = Math.floor((sunday - firstSunday) / 86400000);
        const week = Math.floor(diffDays / 7) + 1;
        return `${year}-W${String(week).padStart(2,'0')}`;
      }

      // expose helpers for testing
      window.__ghx_getWeekKey = getWeekKey;

      function loadUser(user){
        try { return JSON.parse(localStorage.getItem(storageKey(user))) || null; }
        catch { return null; }
      }
      function saveUser(user, data){ localStorage.setItem(storageKey(user), JSON.stringify(data)); }

      function updateStreakOnLogin(user){
        const nowKey = getWeekKey();
        let data = loadUser(user) || { streak: 0, lastWeek: null };
        if (data.lastWeek !== nowKey) {
          // new week detected ‚Üí increment once, never reset for gaps
          data.streak = (data.streak || 0) + 1;
          data.lastWeek = nowKey;
        }
        saveUser(user, data);
        streakCountEl.textContent = String(data.streak || 0);
      }
      window.__ghx_updateStreakOnLogin = updateStreakOnLogin; // test hook

      function setLoggedInUI(user){
        loggedInUser = user;
        authStatus.style.display = 'block';
        currentUserEl.textContent = user;
        streakPanel.hidden = false;
        loginForm.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        const data = loadUser(user) || { streak: 0 };
        streakCountEl.textContent = String(data.streak || 0);
      }
      function setLoggedOutUI(){
        loggedInUser = null;
        authStatus.style.display = 'none';
        streakPanel.hidden = true;
        loginForm.style.display = 'block';
        logoutBtn.style.display = 'none';
        currentUserEl.textContent = '';
      }

      loginForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        const user = (usernameInput.value || '').trim();
        if (!user) return;
        updateStreakOnLogin(user);
        setLoggedInUI(user);
        localStorage.setItem('ghx_last_user', user);
      });
      logoutBtn.addEventListener('click', ()=>{ setLoggedOutUI(); });

      // Prefill last username (no auto-increment)
      const lastUser = localStorage.getItem('ghx_last_user');
      if (lastUser) { usernameInput.value = lastUser; }
    })();

    // ===== Game Logic =====
      const pyramid = [1, 2, 3, 4, 5, 7];
    const code =  [8, "F", 9, "B", 1, "E",5 ];

    const questions = [
      "‚à´ (2x + 5) dx = x^2 + 5x + __  ",
      "Button used to refresh a browser on a PC ",
      "10 permute 3 ",
      "Past tense of bid ",
      "Synthetic divide (9x^5 -33x^4 -11x^3 +2x^2 -20x -16) / (x-4) ",
      "Enter the unused Hex digit, followed by the code"
    ];

    const correctAnswers = [
      ["C"],
      ["F", 5],
      [7, 2 , 0],
      ["B", "A", "D", "E"],
      [9, 3, 1, 6, 4],
      [8, "F", 9, "B", 1, "E",5 ]
    ];

    let currentStep = 0;

    const questionsDiv = document.getElementById("questions");
    const guessContainer = document.getElementById("guess-container");
    const submitBtn = document.getElementById("submit");
    const gameOverDiv = document.getElementById("game-over");
    const startScreen = document.getElementById("start-screen");
    const startButton = document.getElementById("start-button");
    const trackerDiv = document.getElementById("tracker");
    const timerDiv = document.getElementById("timer");

    let usedCharacters = new Set();
    let questionElements = [];

    const hexChars = [...Array(10).keys()].map(String).concat(["A","B","C","D","E","F"]);
    function handleTrackerChar(char) {
      const activeInputs = getActiveInputs();
      if (!activeInputs.length) return;

      let target = document.activeElement;
      const isActiveCell = target && target.classList && target.classList.contains("cell") && target.classList.contains("active");
      if (!isActiveCell) {
        target = activeInputs.find(input => input.value === "") || activeInputs[0];
      }

      if (!target) return;

      target.value = char.toUpperCase();
      target.dispatchEvent(new Event("input", { bubbles: true }));
      if (typeof target.focus === "function") {
        target.focus();
      }
    }

    function updateTracker() {
      trackerDiv.innerHTML = "";
      hexChars.forEach(char => {
        const span = document.createElement("span");
        span.className = "tracker-char" + (usedCharacters.has(char) ? " used" : "");
        span.textContent = char;
        span.setAttribute("role", "button");
        span.tabIndex = 0;
        const activate = () => handleTrackerChar(char);
        span.addEventListener("click", activate);
        span.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            activate();
          }
        });
        trackerDiv.appendChild(span);
      });
    }

    // ‚è± Timer helpers
    let startTime = null;
    let timerInterval = null;
    let elapsedSeconds = 0;

    function formatSeconds(total) {
      const m = String(Math.floor(total / 60)).padStart(2, '0');
      const s = String(total % 60).padStart(2, '0');
      return `${m}:${s}`;
    }

    function startTimer() {
      startTime = Date.now();
      elapsedSeconds = 0;
      timerDiv.textContent = '‚è± 00:00';
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        timerDiv.textContent = `‚è± ${formatSeconds(elapsed)}`;
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
      elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
      return formatSeconds(elapsedSeconds);
    }

    function getPerformanceRating(secondsTaken) {
      if (secondsTaken < 60) return { badge: "üíé", label: "Legendary speed" };
      if (secondsTaken <= 300) return { badge: "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê", label: "Blazing fast" };
      if (secondsTaken <= 450) return { badge: "‚≠ê‚≠ê‚≠ê‚≠ê", label: "Swift solver" };
      if (secondsTaken <= 495) return { badge: "‚≠ê‚≠ê‚≠ê", label: "Solid pace" };
      if (secondsTaken < 600) return { badge: "‚≠ê‚≠ê", label: "Keep practicing" };
      return { badge: "‚≠ê", label: "Persistence pays off" };
    }

    function renderQuestion() {
      // Clear previous questions and only show current one
      questionsDiv.innerHTML = '';
      
      const qWrap = document.createElement("div");
      qWrap.className = "question-container";
      qWrap.id = `question-${currentStep}`;

      const qText = document.createElement("div");
      qText.className = "question-text";
      qText.textContent = questions[currentStep];
      qWrap.appendChild(qText);

      const resultSpan = document.createElement("div");
      resultSpan.className = "question-result";
      resultSpan.id = `result-${currentStep}`;
      qWrap.appendChild(resultSpan);

      questionsDiv.appendChild(qWrap);
      questionElements.push(qWrap);

      const rowDiv = document.createElement("div");
      rowDiv.className = (currentStep === pyramid.length - 1) ? "row final-row" : "row";
      rowDiv.id = `row-${currentStep}`;
      for (let i = 0; i < pyramid[currentStep]; i++) {
        const input = document.createElement("input");
        input.className = "cell active";
        input.maxLength = 1;
        input.type = "text";
        input.autocapitalize = "characters";
        input.addEventListener("input", (e) => {
          input.value = input.value.toUpperCase().replace(/[^0-9A-F]/g, "");
          if (e.target.value.length === 1 && i < pyramid[currentStep] - 1) {
            rowDiv.children[i + 1].focus();
          }
        });
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") submitBtn.click();
          if ((e.key === "Backspace" || e.key === "Delete") && e.target.value === "" && i > 0) {
            rowDiv.children[i - 1].focus();
          }
          if (e.key === "ArrowLeft" && i > 0) {
            e.preventDefault();
            rowDiv.children[i - 1].focus();
          }
          if (e.key === "ArrowRight" && i < rowDiv.children.length - 1) {
            e.preventDefault();
            rowDiv.children[i + 1].focus();
          }
        });
        rowDiv.appendChild(input);
      }

      guessContainer.appendChild(rowDiv);
      rowDiv.children[0].focus();
    }

    function getActiveInputs() { return Array.from(document.querySelectorAll(".cell.active")); }
    function getInputValues()  { return getActiveInputs().map(input => input.value.trim()); }

    function shakeRow(rowDiv) { rowDiv.classList.add("shake"); setTimeout(() => rowDiv.classList.remove("shake"), 300); }

    // Pure helper for tests and feedback generation
    function computeFeedbackForRow(inputDigits, rowLen) {
      const codeUpper = code.map(x => String(x).toUpperCase());
      const offset = Math.max(0, codeUpper.length - rowLen);
      return inputDigits.map((digit, i) => {
        const d = String(digit).toUpperCase();
        const target = codeUpper[offset + i];
        if (target === d) return "green";
        if (codeUpper.includes(d)) return "yellow";
        return "gray";
      });
    }

    function evaluateRow(values, rowDiv) {
      const inputDigits = values.map(v => (isNaN(v) ? v.toUpperCase() : Number(v)));
      const expected = correctAnswers[currentStep];

      const isCorrect = inputDigits.length === expected.length && inputDigits.every((val, i) => {
        const exp = expected[i];
        return (typeof exp === "string") ? String(val).toUpperCase() === exp.toUpperCase() : val === exp;
      });

      if (!isCorrect) { shakeRow(rowDiv); return false; }

      document.getElementById(`result-${currentStep}`).textContent = "‚úÖ";

      // Right-anchored position mapping
      const feedback = computeFeedbackForRow(inputDigits, pyramid[currentStep]);

      // Paint cells + lock row
      getActiveInputs().forEach((input, i) => {
        input.classList.remove("active");
        input.classList.add(feedback[i]);
        input.disabled = true;
      });

      inputDigits.forEach(d => usedCharacters.add(String(d).toUpperCase()));
      updateTracker();
      return true;
    }

    function hideAnsweredQuestions() {
      // Hide all questions except the current one (defensive if multiple were present)
      questionElements.forEach((element, index) => {
        if (index !== currentStep) { element.classList.add('hidden'); }
      });
    }

    // ===== Sharing helpers =====
    const GAME_SHARE_URL = 'https://cordell33.github.io/GodleHex/';

    function buildShareText() {
      // Collect all guess rows, but EXCLUDE the final 7-cell row from the share grid
      const rows = Array.from(document.querySelectorAll('.guesses .row'));
      if (!rows.length) return '';
      const playableRows = rows.slice(0, -1); // drop last row (final code)

      // Determine the visual width of the share grid so we can right-align rows
      const maxPlayableWidth = playableRows.reduce((max, row) => {
        const cellCount = row.querySelectorAll('.cell').length;
        return Math.max(max, cellCount);
      }, 0);

      // Map cell classes to colored squares only
      const mapColor = (el) => (
        el.classList.contains('green') ? 'üü©' :
        el.classList.contains('yellow') ? 'üü®' : '‚¨õ'
      );

      // Because the visual pyramid stacks upward, reverse to show top‚Üíbottom visually
      const grid = playableRows
        .map(r => {
          const cells = Array.from(r.querySelectorAll('.cell'));
          const colors = cells.map(mapColor).join('');
          const missingCells = Math.max(0, maxPlayableWidth - cells.length);
          // Pad by 5 spaces per missing cell so the share grid mimics the visual cell width.
          const padding = ' '.repeat(missingCells * 5);
          return padding + colors;
        })
        .reverse()
        .join('\n');

      // Header: Title before time
      const title = 'Godle Hex';
      const timeText = (timerDiv ? timerDiv.textContent.replace('‚è±','').trim() : '').trim();
      const header = `${title} ‚Äî ${timeText}`.trim();

      // Streak line (only if logged in)
      const streakEl = document.getElementById('streak-count');
      let weeks = 0;
      if (streakEl) {
        const n = parseInt(streakEl.textContent, 10);
        weeks = Number.isFinite(n) ? n : 0;
      }
      let streakLine = '';
      const userLoggedIn = document.getElementById('auth-status') && document.getElementById('auth-status').style.display !== 'none';
      if (userLoggedIn) {
        if (weeks === 0) {
          streakLine = `(newbie) üî•`;
        } else {
          const weeksLabel = weeks === 1 ? 'week' : 'weeks';
          streakLine = `(${weeks} ${weeksLabel}) üî•`;
        }
      }

      // Return: header, grid, then optional streak line on its own row
      const pieces = [header, grid];
      if (streakLine) pieces.push(streakLine);
      pieces.push(`Play: ${GAME_SHARE_URL}`);
      return pieces.filter(Boolean).join('\n').trim();
    }

    async function copyResults() {
      const text = buildShareText();
      try { await navigator.clipboard.writeText(text); } catch {}
      const copyMsg = document.getElementById('copy-message');
      if (copyMsg) { copyMsg.style.display = 'block'; setTimeout(()=>copyMsg.style.display='none', 2000); }
    }

    function shareOnTwitter(){
      const text = buildShareText();
      window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank', 'noopener');
    }

    function shareOnFacebook(){
      const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(GAME_SHARE_URL)}&quote=${encodeURIComponent(buildShareText())}`;
      const win = window.open(shareUrl, 'fb-share-dialog', 'width=626,height=436');
      if (!win) { copyResults(); alert('Facebook share popup was blocked. Your results were copied‚Äîpaste into Facebook manually.'); }
    }

    // Hook up buttons (if they exist) + auto-show at game over
    (function(){
      const sr = document.getElementById('share-results');
      const tw = document.getElementById('share-twitter');
      const fb = document.getElementById('share-facebook');
      const cp = document.getElementById('share-copy');
      if (tw) tw.addEventListener('click', shareOnTwitter);
      if (fb) fb.addEventListener('click', shareOnFacebook);
      if (cp) cp.addEventListener('click', copyResults);
      const go = document.getElementById('game-over');
      if (go && sr) {
        const mo = new MutationObserver(()=>{ if (go.textContent.trim().length) sr.style.display = 'flex'; });
        mo.observe(go, { childList:true, subtree:true });
      }
    })();

    function attemptSubmit() {
      const rowDiv = guessContainer.lastElementChild;
      const values = getInputValues();
      if (values.length < pyramid[currentStep] || values.some(v => v === "")) return;

      const correct = evaluateRow(values, rowDiv);
      if (!correct) return;

      hideAnsweredQuestions();

      currentStep++;
      if (currentStep < pyramid.length) {
        renderQuestion();
      } else {
        const guess = values.map(v => (isNaN(v) ? v.toUpperCase() : Number(v)));
        const solved = guess.every((d, i) => d === code[i]);
        const finalTime = stopTimer();
        gameOverDiv.classList.remove('win', 'loss');
        if (solved) {
          const rating = getPerformanceRating(elapsedSeconds);
          gameOverDiv.textContent = `üéâ You cracked the code in ${finalTime}! ${rating.badge} ${rating.label}`;
          gameOverDiv.classList.add('win');
        } else {
          gameOverDiv.textContent = `‚ùå Incorrect. The code was ${code.join("")}. Time: ${finalTime}`;
          gameOverDiv.classList.add('loss');
        }
        submitBtn.disabled = true;
      }
    }

    submitBtn.addEventListener("click", attemptSubmit);

    document.addEventListener("keydown", (event) => {
      if (event.key !== "Enter" || event.repeat) return;
      if (submitBtn.disabled) return;
      if (startScreen && startScreen.style.display !== "none") return;
      if (event.target && event.target.closest && event.target.closest('#side-menu')) return;

      const hasInputs = getActiveInputs().length > 0;
      if (!hasInputs) return;

      const values = getInputValues();
      if (values.length < pyramid[currentStep] || values.some(v => v === "")) return;

      event.preventDefault();
      attemptSubmit();
    });

    startButton.addEventListener("click", () => {
      startScreen.style.display = "none";
      updateTracker();
      startTimer();
      renderQuestion();
    });

    /* ==================
       Dev Self-Tests
       Run in console: runTests()
       ================== */
    function runTests() {
      console.log("Running G√∂dle Hex tests...");
      console.assert(document.getElementById('timer'), 'Timer element should exist');
      console.assert(typeof startTimer === 'function', 'startTimer should be defined');
      console.assert(typeof stopTimer === 'function', 'stopTimer should be defined');
      console.assert(typeof formatSeconds === 'function', 'formatSeconds should be defined');
      console.assert(formatSeconds(0) === '00:00', 'formatSeconds(0)');
      console.assert(formatSeconds(5) === '00:05', 'formatSeconds(5)');
      console.assert(formatSeconds(65) === '01:05', 'formatSeconds(65)');

      // Final row alignment
      const prevStep = currentStep;
      currentStep = pyramid.length - 1; renderQuestion();
      const lastRow = document.getElementById(`row-${currentStep}`);
      console.assert(lastRow && lastRow.classList.contains('final-row'), 'Final row should have class final-row');
      // cleanup
      currentStep = prevStep; 

      // Sunday-based week key should change across Sat->Sun
      const wkSat = window.__ghx_getWeekKey(new Date('2025-09-27')); // Saturday
      const wkSun = window.__ghx_getWeekKey(new Date('2025-09-28')); // Sunday next week
      console.assert(wkSat !== wkSun, 'Week key should change from Saturday to next Sunday');
      const wkSun2 = window.__ghx_getWeekKey(new Date('2025-09-28'));
      const wkFri = window.__ghx_getWeekKey(new Date('2025-10-03')); // same Sun-Sat week
      console.assert(wkSun2 === wkFri, 'Sunday and following Friday should share the same week key');

      // New: feedback mapping helper tests (right-anchored)
      const fb1 = computeFeedbackForRow(["F","B",8], 3); // should match last 3 of code
      console.assert(JSON.stringify(fb1) === JSON.stringify(["green","green","green"]), 'Right-anchored last 3 should be all green');
      const fb2 = computeFeedbackForRow([7,"F"], 2); // both in code but not at last-2 exact spots
      console.assert(fb2.every(c => c === 'yellow' || c === 'green'), 'Digits from code should not be gray');

      // New: basic sharing output structure (safe to call anytime)
      const shareText = buildShareText();
      console.assert(typeof shareText === 'string', 'Share text should be a string');

      console.log("All tests passed ‚úÖ");
    }
    window.runTests = runTests;
  </script>
</body>
</html>
